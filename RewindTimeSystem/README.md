<!-- omit in toc -->

# 時戻しプラグイン

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/168f4df9-7e79-4f09-8da3-11e9271783ef)

本プラグインを導入すると、マップコマンド「**時戻し**」が使用できるようになります。  
※コマンド名は変更可。以降、便宜上「時戻し」と呼ぶ。

<br>

-   [1. 機能](#1-機能)
    -   [1.1. 時戻しの仕組み](#11-時戻しの仕組み)
    -   [1.2. マップコマンドによる時戻し](#12-マップコマンドによる時戻し)
    -   [1.3. ゲームオーバーを回避する時戻し](#13-ゲームオーバーを回避する時戻し)
-   [2. 導入手順](#2-導入手順)
    -   [2.1. ファイルを Plugin フォルダ配下に保存する](#21-ファイルを-plugin-フォルダ配下に保存する)
    -   [2.2. スクリプト内の変数の設定](#22-スクリプト内の変数の設定)
    -   [2.3. グローバルスイッチの設定](#23-グローバルスイッチの設定)
    -   [2.4. 自動開始イベントの設定](#24-自動開始イベントの設定)
-   [3. 追加設定](#3-追加設定)
    -   [3.1. ゲームオーバーの設定](#31-ゲームオーバーの設定)
    -   [3.2. イベントコマンド「ユニットの登場」使用時の設定](#32-イベントコマンドユニットの登場使用時の設定)
    -   [3.3. 巻き戻さないスイッチを個別に設定](#33-巻き戻さないスイッチを個別に設定)
    -   [3.4. 自作ユニットコマンドの設定：基礎編](#34-自作ユニットコマンドの設定基礎編)
    -   [3.5. 自作ユニットコマンドの設定：応用編](#35-自作ユニットコマンドの設定応用編)
-   [4. 補足](#4-補足)
    -   [4.1. 乱数について](#41-乱数について)
    -   [4.2. 時戻しで何が巻き戻るのか](#42-時戻しで何が巻き戻るのか)

<br>

## 1. 機能

### 1.1. 時戻しの仕組み

以下のタイミングでマップ上の全ユニットとセッションの状態を履歴に残すことで、  
過去の状態を復元する機能を実現しています。

-   自軍フェイズ開始時
-   自軍ユニットの行動後

以降、この履歴のことを「**レコード**」と呼びます。

レコードはスクリプトによって管理され、セーブ時にセーブファイル内に保存されます。  
セーブファイルをロードしてマップの途中から再開した場合も、  
そのマップでのレコードは全て保持されています。

<br>

### 1.2. マップコマンドによる時戻し

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/6354c3d9-2581-47f1-91ae-d262e911aecb)

マップコマンド「時戻し」を選択すると専用の画面が開きます。  
以降、この画面のことを「**時戻し画面**」と呼びます。

コマンドは後述の設定によって表示/非表示を切り替えることができます。

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/38d82e73-0cb5-4d8d-bf1e-b65f693ed236)

時戻し画面ではレコード一覧と時戻しの残り回数が表示され、  
カーソルを移動するとカーソル中のレコードの状態が画面に反映されます。

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/a6fd5c9c-ff8e-48b1-b4ef-b8ab82e20e24)

例えば上の画像の場合、3 ターン目の自軍フェイズ開始時の状態が反映され、  
ユニットの位置や HP なども 4 ターン目の自軍フェイズ開始時とは異なるものになっています。

（厳密には処理の軽量化の都合で全ての状態を変化させているわけではないのですが、詳細は割愛します）

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/c9efd6ac-a305-4afc-b0db-1e19aab5873f)

レコードを選択すると、時戻しを実行するか確認する選択肢が表示されます。

「はい」を選ぶと時戻しが実行され、選択したレコードに記録されている状態が全て復元されます。  
その後、選択したレコードより後のレコードは全て破棄されます。

上の画像の場合、「3 ターン目開始」のレコードを選択すると 3 ターン目の自軍フェイズ開始時の状態まで巻き戻り、  
「ルーシーが攻撃した」「ナッシュが待機した」「ランバートが杖を使った」「4 ターン目開始」のレコードは破棄されます。

「いいえ」を選ぶと選択肢が閉じます。

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/2900ee44-363d-4667-8430-0144d1d316c2)

時戻し画面でキャンセルするとマップコマンド選択に戻ります。

このとき、時戻し画面でレコードの状態を一時的に画面に反映していた処理も全てキャンセルされ、  
元の状態に戻ります。

<br>

### 1.3. ゲームオーバーを回避する時戻し

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/3a390be5-8a12-45f6-8582-865ba852c4de)

以下の条件を満たしたとき、自動的に時戻し画面が開きます。

-   重要度「リーダー」のユニットが死亡する
-   「自軍全滅時敗北」が有効でかつ自軍ユニットが一人も生存していない
-   ゲームオーバー判定用のグローバルスイッチがオンになっている（後述）

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/e0e3673e-ea0c-4b09-a359-708b04134281)

ここで時戻しを実行することで、ゲームオーバーを無かったことにしてやり直しができます。

なお、このとき最新のレコードは選択不可となっています。  
（再度敗北条件を満たしてしまうので意味がないため）

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/ca63f054-8dc4-4a9f-bd2e-c859200ff8d5)

キャンセルしようとすると、時戻しを使わないとゲームオーバーになる旨のメッセージが表示されます。  
この選択肢で「はい」を選択するとそのままゲームオーバーになり、  
「いいえ」を選択すると選択肢が閉じます。

<br>

また、以下の条件のいずれかを満たしている場合は時戻し画面が開かずゲームオーバーになります。

-   時戻しの残り回数が 0 である
-   時戻し使用可のグローバルスイッチがオフになっている（後述）

<br>

## 2. 導入手順

### 2.1. ファイルを Plugin フォルダ配下に保存する

RewindTimeSystem.js をプロジェクトの Plugin フォルダ配下に保存してください。

<br>

### 2.2. スクリプト内の変数の設定

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/7fb0af6f-2aa4-457c-8fc3-1bc1319807c1)

RewindTimeSystem.js 内の設定項目を必要に応じて変更してください。

以下は設定項目の一覧になります。

| 変数名                                  | 内容                                                             |
| --------------------------------------- | ---------------------------------------------------------------- |
| REWIND_COMMAND_NAME                     | 時戻しコマンドの名称                                             |
| REWIND_COMMAND_INDEX                    | 時戻しコマンドを上から何番目に表示するか                         |
| REWIND_COUNT_LIMIT                      | 1 マップあたりの時戻しの上限回数                                 |
| REWIND_EXEC_QUESTION_MESSAGE            | 時戻しを実行するか確認するメッセージ                             |
| REWIND_CANCEL_QUESTION_MESSAGE          | ゲームオーバー前の時戻し画面でのキャンセル時に表示するメッセージ |
| REMAIN_REWIND_COUNT_TEXT                | 時戻しの残り回数を表す文字列                                     |
| REMAIN_COUNT_LIMITLESS                  | 時戻しの残り回数が無制限のときに数値の代わりに表示する文字列     |
| IS_REWIND_COMMAND_DISPLAYABLE_SWITCH_ID | 時戻しコマンド表示のグローバルスイッチ ID                        |
| CAN_REWIND_SWITCH_ID                    | 時戻しコマンド使用可のグローバルスイッチ ID                      |
| APPEND_RECORD_SWITCH_ID                 | 自軍ユニット行動後判定のグローバルスイッチ ID                    |
| IS_GAME_OVER_SWITCH_ID                  | ゲームオーバー判定のグローバルスイッチの ID                      |
| IS_ALLOWED_REWIND_MAP_CUSTOM            | マップのカスパラを巻き戻すかどうか                               |
| IS_ALLOWED_REWIND_UNIT_CUSTOM           | ユニットのカスパラを巻き戻すかどうか                             |
| REWIND_TITLE_WINDOW_X                   | レコード一覧ウィンドウの x 座標                                  |
| REWIND_TITLE_WINDOW_Y                   | レコード一覧ウィンドウの y 座標                                  |
| REWIND_COUNT_WINDOW_X                   | 残り回数ウィンドウの x 座標                                      |
| REWIND_COUNT_WINDOW_Y                   | 残り回数ウィンドウの y 座標                                      |
| REWIND_TITLE_RAW_LIMIT                  | 時戻し画面に一度に表示するレコードの行数                         |
| MUSIC_VOLUME_RATIO                      | 時戻し画面表示中の BGM 音量                                      |
| RecordType                              | レコードの種類                                                   |
| RECORD_TITLE_STRING_ARRAY               | レコードの種類に対応する文字列                                   |

### 2.3. グローバルスイッチの設定

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/e39c7503-e036-43e8-806e-3937f320bb97)

以下の 4 つのグローバルスイッチを作成します。

-   時戻しコマンド表示
-   時戻しコマンド使用可
-   自軍ユニット行動後
-   ゲームオーバー判定

スイッチの名称は適宜分かりやすいものにしてください。  
（以降の説明では便宜的に上記の名称を使用します）

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/72e561d6-7a04-43a9-983d-b04ce7cd1d74)

「時戻しコマンド表示」はオンにするとマップコマンド「時戻し」が表示されるようになります。

「時戻しコマンド使用可」はオンのときマップコマンド「時戻し」が選択可能になり、  
オフのとき選択不可となります。

これら 2 つのスイッチは任意のタイミングでオン/オフを切り替えてください。

「自軍ユニット行動後」はオフのままにしてください。

「ゲームオーバー判定」については後述します。

<br>

### 2.4. 自動開始イベントの設定

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/436e5420-b810-4f92-9208-91382bcbe78e)

以下の 3 つのイベントを自動開始イベントの一番下に作成してください（並び順も以下の通りに）。

-   マップ開始
-   自軍ターン開始
-   自軍ユニット行動後

これも名称は適宜分かりやすいものにしてください。  
（以降の説明では便宜的に上記の名称を使用します）

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/fe6b5098-a98c-401d-9a8b-664f07e9a84d)

「マップ開始」は実行条件を「マップ開始時」にし、  
イベントコマンド「スクリプトの実行」を作成して以下のコードを入力してください。

```
RewindTimeManager.startMap();
RewindTimeManager.setIsIgnoredSwitch(true, 5, true); // 数値は「時戻しコマンド表示」のスイッチIDを指定
RewindTimeManager.setIsIgnoredSwitch(true, 6, true); // 数値は「時戻しコマンド使用可」のスイッチIDを指定
RewindTimeManager.setIsIgnoredSwitch(true, 7, true); // 数値は「自軍ユニット行動後」のスイッチIDを指定
```

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/49b5cc5b-96e6-4cab-a49b-ede22c262374)

「自軍ターン開始」は実行条件を「自軍ターン開始時」にし、  
イベントコマンド「イベントの状態変更」で「自軍ターン開始」を実行済み解除にしてください。

次に、イベントコマンド「スクリプトの実行」を作成して以下のコードを入力してください。

```
RewindTimeManager.appendRecord(RecordType.TURN_START);
```

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/3bb74a5b-4ed7-4964-a2b5-778aee9f9a9c)

「自軍ユニット行動後」は実行条件をグローバルスイッチ「自動ユニット行動後」のオンにし、  
イベントコマンド「イベントの状態変更」で「自軍ユニット行動後」を実行済み解除に、  
イベントコマンド「スイッチ変更」でグローバルスイッチ「自動ユニット行動後」をオフにしてください。

次に、イベントコマンド「スクリプトの実行」を作成して以下のコードを入力してください。

```
var recordType = RewindTimeManager.getCurRecordType();
RewindTimeManager.appendRecord(recordType);
```

<br>

最後に、「マップ開始」「自軍ターン開始」「自軍ユニット行動後」以外の全ての自動開始イベントの条件に  
グローバルスイッチ「ゲームオーバー判定」がオフであることを設定してください。

<br>

以上で基本設定は完了となります。

<br>

## 3. 追加設定

### 3.1. ゲームオーバーの設定

敗北条件を満たしたときなどにゲームオーバー扱いにしたい場合、  
「シーンの変更」でゲームオーバーに移行する代わりにグローバルスイッチ「ゲームオーバー判定」をオンにすることで  
時戻し画面が自動的に開くようになります。

ただし、前述したように以下の条件のいずれかを満たしているときはそのままゲームオーバーになります。

-   時戻しの残り回数が 0 である
-   時戻し使用可のグローバルスイッチがオフになっている

<br>

### 3.2. イベントコマンド「ユニットの登場」使用時の設定

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/08c36fd6-db61-444a-ae15-6c3245a93c04)

イベントコマンド「ユニットの登場」で敵イベントなどのユニットを登場させる場合、  
そのコマンドの真下に「スクリプトの実行」を作成し、以下のようにコードを入力してください。

```
// RewindTimeManager.addUnitById(ユニットの所属, ユニットの種類, エディタ上のユニットID);
// 以下は入力例
RewindTimeManager.addUnitById(UnitType.ENEMY, UnitGroup.ENEMYEVENT, 5);
// この場合、ユニットの所属は敵軍、種類は敵イベント、IDは5
```

ユニットの所属と種類については以下を参考に入力してください。

| 所属   | 入力内容        |
| ------ | --------------- |
| 自軍   | UnitType.PLAYER |
| 敵軍   | UnitType.ENEMY  |
| 同盟軍 | UnitType.ALLY   |

| 種類           | 入力内容             |
| -------------- | -------------------- |
| プレイヤー     | UnitGroup.PLAYER     |
| 敵イベント     | UnitGroup.ENEMYEVENT |
| 同盟イベント   | UnitGroup.ALLYEVENT  |
| ゲストイベント | UnitGroup.GUESTEVENT |
| 援軍           | UnitGroup.REINFORCE  |

<br>

### 3.3. 巻き戻さないスイッチを個別に設定

時戻しで状態を巻き戻したくないスイッチがある場合、  
イベントコマンド「スクリプトの実行」で以下のコードを入力することで個別に設定できます。

```
// RewindTimeManager.setIsIgnoredSwitch(※1, ※2, ※3);
// ※1 グローバルスイッチの場合はtrue、ローカルスイッチの場合はfalse
// ※2 スイッチのID
// ※3 巻き戻さない設定にする場合はtrue、巻き戻す場合はfalse
// 以下は入力例
RewindTimeManager.setIsIgnoredSwitch(true, 5, true);
// この場合、グローバルスイッチのID5を巻き戻さない設定にする
RewindTimeManager.setIsIgnoredSwitch(false, 7, false);
// この場合、ローカルスイッチのID7を巻き戻す設定にする
```

<br>

### 3.4. 自作ユニットコマンドの設定：基礎編

プラグインで自作のユニットコマンドを導入している場合、  
そのコマンドに対応するレコードの文字列を設定する必要があります。

例として「フォースアタック」という自作コマンドの設定をしてみます。

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/0593a53a-e090-4469-8571-a433f9288e2f)

まず、スクリプトの設定項目内にある RecordType に新しいプロパティを追加します。

```
var RecordType = {
    TURN_START: 0, // 自軍フェイズ開始
    ︙
    (中略)
    ︙
    PROGRESS_ALLYPHASE: 18, // 同盟軍フェイズ進行中
    UNIT_FORCEATTACK: 19 // フォースアタック
}
```

コロンの左側はプロパティ名(UNIT_FORCEATTACK)、右側は識別子となる数値(19)です。
いずれも他の項目と重複しないようにしてください。

また、このとき最後の行以外は末尾に必ずカンマをつけるようにしてください。

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/4b1d04a8-8cdb-4dd7-9278-54dd01f69784)

次に、RecordTitleString にもプロパティを追加します。

```
var RecordTitleString = {
    0: "ターン目開始", // 自軍フェイズ開始
    ︙
    (中略)
    ︙
    18: "同盟軍フェイズ進行中", // 同盟軍フェイズ進行中
    19: "がフォースアタックを放った" // フォースアタック
};
```

コロンの左側には RecordType で設定した数値(今回の場合は 19)を、  
右側には時戻し画面で表示する用の文字列を設定します。

コメント文にもある通り、文字列に関しては頭にユニット名がつくことを想定して設定してください。

また、ここでも最後の行以外は末尾に必ずカンマをつけるようにしてください。

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/edad6be0-457c-409f-bab1-8d841809e7b7)

最後に、自作ユニットコマンドの openCommand メソッド内に以下を追記します。

```
RewindTimeManager.setCurRecordType(RecordType.UNIT_FORCEATTACK);
```

UNIT_FORCEATTACK の部分は、RecordType で設定したプロパティ名を入力してください。

<br>

以上で設定は完了です。

実際にコマンドを使ってみると、時戻し画面にもちゃんと反映されています。

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/a0b39620-da65-443c-96fd-cef8d59c18fa)

![capture8](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/64d57faa-19b1-4df4-ae8c-48040b3d5e4a)

~~フォースアタックという名のただの攻撃~~

<br>

### 3.5. 自作ユニットコマンドの設定：応用編

同じユニットコマンドでも、状況によってコマンド名や処理が変わるケースもあり、  
その場合は時戻し画面に表示する文字列も適宜切り替える必要があります。

例として、名前未定（仮）氏の「疑似アイテムスキル」の設定をしてみます。

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/65f3de49-5a78-4ab5-8faf-02ead02082e8)

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/471e9cb7-a828-4538-8d34-d90cfdf5ffcc)

このプラグインはユニットコマンド形式で疑似的にアイテムを使用できるというもので、  
アイテムの指定が変わればコマンド名も処理も変わるので、  
基礎編と同じやり方だと上手くいきません。

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/aa6430cf-55cb-4ca2-906d-2c6f756f6803)

解決策としては、openCommand メソッド内に追記するコードを以下のように変更します。

```
RewindTimeManager.setCurRecordType(this._skill.custom.recordType);
```

this.\_skill.custom.recordType は、スキルのカスタムパラメータの recordType プロパティを指します。

詳細は割愛しますが、これによってスキル毎(コマンド毎)に別々の recordType を設定できるようになります。

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/4e8ee990-3c22-4673-a6e7-84d68ba33a92)

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/2e7e1345-5c9c-4a3d-bf73-59f82ef64a51)

RecordType にプロパティを追加し、  
スキルのカスタムパラメータの recordType プロパティは以下のように設定します。

```
{
  recordType: RecordType.UNIT_WARP
}
```

<br>

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/115ad4fa-6d48-40bd-9f44-8be5698243a9)

RecordTitleString にもプロパティを追加します。

以上で設定は完了です。

実際に疑似アイテムスキルのコマンドを使ってみると、  
時戻し画面にもちゃんと反映されています。

![image](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/b7cd0557-caff-4f91-9ce6-a0eb22eef904)

![capture10](https://github.com/sangoopan/srpg-studio-plugin/assets/117929386/8b6e9ca2-11e1-408a-b939-6d115285e719)

<br>

## 4. 補足

### 4.1. 乱数について

本プラグインの仕様として、時戻しを実行すると乱数も巻き戻るので、  
同じ行動を繰り返す限りは戦闘結果や能力値成長などの内容が変化することはありません。

これを実現するため、本プラグインでは乱数の生成方法をデフォルトから変更しています。

デフォルトでは root.getRandomNumber()という組み込みのメソッドで乱数を生成していますが、  
この機能はシード値の設定はできても取得はできないので、乱数の状態をレコードに記録することができません。

そのため、Probability オブジェクト内に乱数生成アルゴリズムを別途実装することで機能を代替しています。

お使いの他のプラグインで root.getRandomNumber()を使用している箇所がある場合、  
以下に置き換えることを推奨します。

```
Probability.getRandomNumber()
```

<br>

### 4.2. 時戻しで何が巻き戻るのか

レコードに記録されるユニットとセッションの状態について以下の表にまとめました。

大抵の事象は巻き戻せますが、漏れもあるかも…  
（他にもこういうことができたら嬉しい、などのご要望がありましたらお気軽にコメントしてください）

<br>

| 種別       | 内容                                       |
| ---------- | ------------------------------------------ |
| ユニット   | 名前                                       |
| ユニット   | 顔画像                                     |
| ユニット   | クラス                                     |
| ユニット   | 重要度                                     |
| ユニット   | モーションの色                             |
| ユニット   | レベル                                     |
| ユニット   | 経験値                                     |
| ユニット   | 能力値                                     |
| ユニット   | 現在 HP                                    |
| ユニット   | 所持アイテム                               |
| ユニット   | 所持スキル                                 |
| ユニット   | 成長率                                     |
| ユニット   | クラスチェンジ回数                         |
| ユニット   | フュージョンの状態                         |
| ユニット   | 形態変化の状態                             |
| ユニット   | 所属                                       |
| ユニット   | マップ上の座標                             |
| ユニット   | スライド値                                 |
| ユニット   | 向き                                       |
| ユニット   | 生存状態                                   |
| ユニット   | 出撃状態                                   |
| ユニット   | 行動順に関する値                           |
| ユニット   | 次の再行動発生許可までのターン数           |
| ユニット   | ステート                                   |
| ユニット   | 待機状態                                   |
| ユニット   | 非表示状態                                 |
| ユニット   | 不死身状態                                 |
| ユニット   | 退却可能状態                               |
| ユニット   | バッドステートガード状態                   |
| ユニット   | 行動停止状態                               |
| ユニット   | キャッチ状態                               |
| ユニット   | カスタムパラメータ                         |
| セッション | マップチップ                               |
| セッション | マップチップ(透過レイヤー)                 |
| セッション | マップカーソルの座標                       |
| セッション | スクロール値                               |
| セッション | ゴールド                                   |
| セッション | ボーナス                                   |
| セッション | ストックアイテム                           |
| セッション | グローバルスイッチ                         |
| セッション | ローカルスイッチ                           |
| セッション | 変数                                       |
| セッション | 場所イベントの実行済み状態                 |
| セッション | 自動実行イベントの実行済み状態             |
| セッション | 会話イベントの実行済み状態                 |
| セッション | オープニングイベントの実行済み状態         |
| セッション | エンディングイベントの実行済み状態         |
| セッション | コミュニケーションイベントの実行済み状態   |
| セッション | マップ共有イベントの実行済み状態           |
| セッション | 侵入禁止領域の境界値                       |
| セッション | ターン数                                   |
| セッション | フェイズ                                   |
| セッション | トロフィー                                 |
| セッション | 勝利条件                                   |
| セッション | 敗北条件                                   |
| セッション | 店の商品ラインナップと在庫数               |
| セッション | 場所イベントの店の商品ラインナップと在庫数 |
| セッション | BGM                                        |
| セッション | 画面効果                                   |
| セッション | マップのカスタムパラメータ                 |
| その他     | 乱数                                       |

<br>

<!-- omit in toc -->

# 障害物を設置する杖

![image](https://github.com/user-attachments/assets/7ac29c2e-08ac-47cf-9554-4b59d1ae4ce0)

本プラグインを導入すると、射程内の任意の 1 マスに通り抜け不可の障害物を設置する杖を実装できます。

<br>

-   [障害物を設置する杖](#障害物を設置する杖)
    -   [1. 機能](#1-機能)
        -   [1.1. デモ](#11-デモ)
        -   [1.2. 障害物の仕様](#12-障害物の仕様)
    -   [2. 導入手順](#2-導入手順)
        -   [2.1. ファイルを Plugin フォルダ配下に保存する](#21-ファイルを-plugin-フォルダ配下に保存する)
        -   [2.2. スクリプト内の変数の設定](#22-スクリプト内の変数の設定)
        -   [2.3. アイテムの設定](#23-アイテムの設定)
        -   [2.4. 障害物ユニットの設定](#24-障害物ユニットの設定)
        -   [2.5. 地形効果の設定](#25-地形効果の設定)
        -   [2.6. 援軍配置の設定](#26-援軍配置の設定)
        -   [2.7. マップのカスタムパラメータの設定](#27-マップのカスタムパラメータの設定)
    -   [3. 追加設定](#3-追加設定)
        -   [3.1. イベントの実行条件に敵軍ユニットの総数を設定したいとき](#31-イベントの実行条件に敵軍ユニットの総数を設定したいとき)
        -   [3.2. ウェイトターンシステムと併用したいとき](#32-ウェイトターンシステムと併用したいとき)
    -   [4. 補足](#4-補足)
        -   [4.1. 敵軍ユニットが障害物を攻撃する条件](#41-敵軍ユニットが障害物を攻撃する条件)
        -   [4.2. 1 ターンに設置する障害物の個数について(※重要)](#42-1-ターンに設置する障害物の個数について重要)

<br>

## 1. 機能

### 1.1. デモ

![gif](https://github.com/user-attachments/assets/24444976-51d3-4eca-b099-49b8a46f8f06)

<br>

### 1.2. 障害物の仕様

障害物は以下の性質を持ちます。

-   内部的には敵軍ユニットとして扱われるが、敵軍ユニットの攻撃対象になる
-   ただし、敵軍ユニットは進路を塞がれているとき以外は障害物に攻撃しない
-   HP が 0 になるか、設置してから 1 ターン経過すると消滅する
-   戦闘時は簡易戦闘になり、受けた攻撃は必ず命中する
-   障害物を対象にとる行動では経験値を獲得できない
-   一部の地形には設置できない

<br>

## 2. 導入手順

### 2.1. ファイルを Plugin フォルダ配下に保存する

Obstruct.js をプロジェクトの Plugin フォルダ配下に保存してください。

<br>

### 2.2. スクリプト内の変数の設定

![image](https://github.com/user-attachments/assets/2c50cef1-4c6c-41a0-b60b-041bb0e2f78a)

Obstruct.js 内の設定項目を必要に応じて変更してください。

<br>

### 2.3. アイテムの設定

![image](https://github.com/user-attachments/assets/37bc13d4-2040-4f69-932b-637362df7c9e)

新規アイテムを作成し、以下の項目を設定します。

-   種類を「カスタム」にする
-   範囲の設定を「指定範囲」にする
-   カテゴリを「杖」に該当するものにする（普通のアイテムとして使うことも一応可能）
-   キーワードを"obstruct"にする

その他の項目は任意に変更してください。

<br>

### 2.4. 障害物ユニットの設定

![image](https://github.com/user-attachments/assets/29558179-baa0-4167-a85a-29775afd5c6d)

援軍ユニットを作成し、以下の項目を設定します。

-   行動パターンを「待機型」にし、「行動できる場合でも待機する」にチェックを入れる
-   アイテムは何も持たせない

このとき、クラスのキャラチップは全コマ同じ画像のものにすると見た目がマップチップっぽくなるのでオススメです。

<br>

### 2.5. 地形効果の設定

![image](https://github.com/user-attachments/assets/aae54c9d-3019-4fb8-b9ed-19a39f48e9cc)

障害物を設置できないようにしたい地形のカスタムパラメータに以下を設定します。

```
{
    isObstacleAllowed: false
}
```

<br>

### 2.6. 援軍配置の設定

![image](https://github.com/user-attachments/assets/ba262350-77dc-40cf-bc29-79e327b9dfcc)

マップの適当なマスで援軍の編集を開き、以下の項目を設定します。

-   ユニットは 2.4.で作った障害物ユニットにする
-   実行条件の「スクリプトを条件にする」にチェックを入れ、false とだけ入力する

このとき、同じマスに他の援軍ユニットを作成することもできますが、  
その場合は障害物ユニットが一番上になるようにしてください。

<br>

### 2.7. マップのカスタムパラメータの設定

![image](https://github.com/user-attachments/assets/2456f871-f7e0-48f3-8683-ae977c1727ad)

マップのカスタムパラメータに以下を設定します。

```
{
  obstructDummyX: 19, // 数値は 2.6.で指定したマスがマップの左から何列目か(一番左を0とする)
  obstructDummyY: 14  // 数値は 2.6.で指定したマスがマップの上から何列目か(一番上を0とする)
}
```

<br>

以上で基本設定は完了となります。

<br>

## 3. 追加設定

### 3.1. イベントの実行条件に敵軍ユニットの総数を設定したいとき

障害物は内部的には敵軍ユニットとして扱われているため、  
イベントの実行条件に敵軍ユニットの総数を指定したいときは特殊な手順を踏む必要があります。

具体的には、「ユニットの総数」タブは使わず、実行条件のスクリプトに以下を設定します。

```
CDB_checkEnemyCountExcludedObstacle(count, overUnderType, aliveType)
```

count は総数の数値を、overUnderType と aliveType は指定したい条件に応じて以下を入力します。

<br>

| 条件       | overUnderType の入力内容  |
| ---------- | ------------------------- |
| ちょうど   | OverUnderType.EQUAL       |
| 以上       | OverUnderType.OVER        |
| 未満       | OverUnderType.UNDER       |
| 等しくない | OverUnderType.NOTEQUALSTO |

<br>

| 生存状態 | aliveType の入力内容 |
| -------- | -------------------- |
| 生存     | AliveType.ALIVE      |
| 死亡     | AliveType.DEATH      |

<br>

例えば、「死亡している敵軍ユニットの総数が 10 体以上」を条件にしたいときは以下のように入力します。

```
CDB_checkEnemyCountExcludedObstacle(10, OverUnderType.OVER, AliveType.DEATH)
```

<br>

### 3.2. ウェイトターンシステムと併用したいとき

![image](https://github.com/user-attachments/assets/e96fbcb0-4d58-4ceb-a6bc-7096a2d19cc4)

プラグイン「ウェイトターンシステム」と本プラグインを併用する場合、  
設定項目の WAIT_TURN_SYSTEM_COEXISTS の値を true に変更してください。

ウェイトターンシステムとの併用時は、障害物が消滅するタイミングが  
「次の自軍フェイズ開始時」→「設置したユニットの次のアタックターン開始時」に変更されます。

<br>

## 4. 補足

### 4.1. 敵軍ユニットが障害物を攻撃する条件

敵軍ユニットは攻撃範囲内に障害物があっても基本的には無視して行動しますが、  
以下の条件を満たしているときのみ障害物に攻撃します。

1. 行動パターンが突撃型（「行動型」で、かつ「範囲内のみ行動する」にチェックが入っていない）
2. 自軍・同盟軍ユニットに攻撃可能なマスに到達するための進路が全て障害物に塞がれている

このとき、進路を塞いでいる障害物が存在しないと仮定して最善の移動ルートを探索し、  
そのルート上にある最も近い障害物が攻撃対象になります。

### 4.2. 1 ターンに設置する障害物の個数について(※重要)

本プラグインの仕様上、マップ上にある障害物の数が増えれば増えるほど、  
4.1.の「進路を塞いでいる障害物が存在しないと仮定して最善の移動ルートを探索する」という処理にかかる時間が指数関数的に増大していきます。

プレイ環境にもよりますが、1 ターンに設置できる障害物は多くとも 5 ～ 6 個ぐらいまでに収まるよう、  
ゲーム側で制限を設けるのが無難だと思います。

<br>

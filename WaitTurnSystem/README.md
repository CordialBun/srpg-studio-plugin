<!-- omit in toc -->

# ウェイトターンシステム

![image](https://github.com/user-attachments/assets/e9b83660-a8dd-4a21-95d9-f8f7020ff33a)

**ウェイトターンシステム**は、ユニットの速さや所持アイテムの重さなどから算出される待機時間（**ウェイトターン**）によってユニットの行動順が決まる非交互ターン制のシステムです。

デフォルトの交互ターン制と違い、自軍フェイズや敵軍フェイズといった概念がなく、  
ウェイトターン(**WT**)が 0 になったユニットから順に所属に関係なく行動できます。

本プラグインを導入することで、ウェイトターンシステムを実現できます。

<br>

-   [ウェイトターンシステム](#ウェイトターンシステム)
    -   [1. 仕様](#1-仕様)
        -   [1.1. アタックターン(AT)の仕組み](#11-アタックターンatの仕組み)
        -   [1.2. WT の算出方法](#12-wt-の算出方法)
        -   [1.3. 行動順リスト](#13-行動順リスト)
        -   [1.4. ターン開始時の演出](#14-ターン開始時の演出)
        -   [1.5. 経過 WT](#15-経過-wt)
        -   [1.6. 環境設定](#16-環境設定)
    -   [2. 導入手順](#2-導入手順)
        -   [2.1. ファイルを Plugin フォルダ配下に保存する](#21-ファイルを-plugin-フォルダ配下に保存する)
        -   [2.2. クラスのカスタムパラメータの設定](#22-クラスのカスタムパラメータの設定)
        -   [2.3. 武器とアイテムの設定](#23-武器とアイテムの設定)
        -   [2.4. マップ共有イベントの設定](#24-マップ共有イベントの設定)
        -   [2.5. 地形の設定](#25-地形の設定)
    -   [3. 追加設定](#3-追加設定)
        -   [3.1. スクリプト内の変数の設定](#31-スクリプト内の変数の設定)
        -   [3.2. リソースの設定](#32-リソースの設定)
    -   [4. 補足](#4-補足)
        -   [4.1. イベントの実行条件について](#41-イベントの実行条件について)

<br>

## 1. 仕様

### 1.1. アタックターン(AT)の仕組み

オープニングイベントが終了すると、マップ上の全ユニットに WT 値が割り当てられます（WT 値の算出方法については後述）。

マップが開始すると、全ユニットの WT 値が同じ速度で減少していき、最初に 0 になったユニットに手番がまわってきます。  
この手番のことを**アタックターン(AT)**、AT がまわってきているユニットのことを**AT ユニット**と呼びます。

AT ユニットはキャラチップの左上に専用のアイコンが表示されます。  
AT ユニット以外のユニットは行動順を示す数値が同じ位置に表示されます。

<br>

![image](https://github.com/user-attachments/assets/ae3484cb-030c-45f6-8cb0-beb6d30c901a)

<br>

複数のユニットの WT 値が同時に 0 になった場合、自軍ユニット → 敵軍ユニット → 同盟軍ユニットの順に優先され、所属も同じ場合は ID が小さい方が優先されます。

AT ユニットが行動終了すると、そのユニットには新たに WT 値が割り当てられます。  
その後、再び全ユニットの WT 値が減少していき、最初に 0 になったユニットに AT がまわる…という流れをマップが終了するまで繰り返します。

<br>

![image](https://github.com/user-attachments/assets/7cad07ef-a667-4540-a025-3e0027baba5e)

<br>

WT 値の減算処理は瞬時に行われるため、プレイヤーの目には AT ユニットが行動終了したら即座に次のユニットに AT がまわっているように見えます。

<br>

### 1.2. WT の算出方法

WT 値は以下の計算式で算出されます。

基本 WT 値 = クラスの WT 値 - ユニットの速さ + 所持アイテムの重さの合計 or 装備中の武器の重さ[^1]  
行動終了後に加算される WT 値 = 基本 WT 値 + 各種補正値[^2]

[^1]: どちらを使用するかは、設定項目の IS_ALL_BELONGINGS_APPLICABLE で選択可。
[^2]: Ver.1.22 現在の仕様では補正値は存在しませんが、今後のアップデートで追加される可能性があります。

<br>

### 1.3. 行動順リスト

ユニットの行動順は画面右側に常に表示されます。これを**行動順リスト**と呼びます。
行動順リストには、ユニットのキャラチップが行動順に並んで表示されます。

<br>

![image](https://github.com/user-attachments/assets/f7317a47-8fa1-4ed8-afa6-ad96bb9f76fe)

<br>

行動順リストの内容は以下のタイミングで更新されます。

-   戦闘準備画面で出撃ユニットを変更した
-   戦闘準備画面でユニットの所持アイテムや装備武器を変更した
-   AT ユニットが行動終了した
-   マップ上のユニットの所持アイテムや装備武器が変更された
-   イベントコマンドや援軍でマップ上のユニットが増減した

<br>

行動順リストはマップチップ 2 列分のスペースを占有します。  
このスペースにはマップカーソルは侵入できません（キーボード操作でもマウス操作でも同様）。

ただし、ユニットの侵入可否は本プラグインでは制御していないので、  
マップ作成時に適宜、該当マスを侵入不可にする必要があります。

<br>

また、行動順リストの表示位置は画面下側に変更することもできます。

![image](https://github.com/user-attachments/assets/b118484e-4c4e-4961-9ac4-14ea911b85d3)

<br>

### 1.4. ターン開始時の演出

本プラグインを導入するとターン開始時の演出の仕様が変わり、
マップ開始時にリソース使用箇所の「UI」→「自軍ターン」の画像が一度だけ表示され、  
以降は「自軍ターン」「敵軍ターン」「同盟軍ターン」のいずれも表示されなくなります。

マップ開始を示す演出を入れたい場合、上記の「自軍ターン」の画像を変更する必要があります。

<br>

### 1.5. 経過 WT

ウェイトターンシステムにはターン数の概念が無いため、目標確認画面やセーブ/ロード画面など、  
ターン数を表示している箇所には代わりに**経過 WT**という項目が表示されます。  
これはマップ開始から経過した WT の合計値を示しています。

![image](https://github.com/user-attachments/assets/2ca35812-a96d-4185-b9ae-edfc6ab86dce)

<br>

### 1.6. 環境設定

本プラグインの処理の都合上、環境設定の以下の項目は変更不可となっており、設定画面にも表示されません。

-   オートターンエンド
-   敵ターンスキップ

<br>

## 2. 導入手順

### 2.1. ファイルを Plugin フォルダ配下に保存する

WaitTurnSystem.js をプロジェクトの Plugin フォルダ配下に保存してください。

<br>

### 2.2. クラスのカスタムパラメータの設定

![image](https://github.com/user-attachments/assets/a206439c-391a-4c11-a7e2-f22c7be9c734)

WT 値を設定したいクラスのカスタムパラメータに以下を設定してください。

```
{
    classWT: クラスのWT値
}
```

例えば、クラスの WT 値を 120 にしたい場合は次のように入力します。

```
{
    classWT: 120
}
```

<br>

### 2.3. 武器とアイテムの設定

![image](https://github.com/user-attachments/assets/fd064019-6779-4f01-95bc-8cf2cda825a4)

任意の武器とアイテムに重さを設定します。

<br>

### 2.4. マップ共有イベントの設定

![image](https://github.com/user-attachments/assets/3e3f50d9-23d9-402c-b4f6-2b2742e4d651)

マップ共有イベントを作成し、種類を「オープニングイベント」、実行順序を「後」に設定します。  
イベントコマンド「スクリプトの実行」を作成して以下のコードを入力してください。

```
WaitTurnOrderManager.initialize();
```

<br>

### 2.5. 地形の設定

マップの右端 2 列分（行動順リストの表示位置を変更している場合は下端 2 列分）を侵入不可能の地形にしてください。

<br>

以上で基本設定は完了となります。

<br>

## 3. 追加設定

### 3.1. スクリプト内の変数の設定

WaitTurnSystem.js 内の設定項目を必要に応じて変更してください。

<br>

![image](https://github.com/user-attachments/assets/615ff7ca-20e7-4217-b15d-432ea6d0948f)

<br>

### 3.2. リソースの設定

リソース使用箇所の「UI」→「自軍ターン」の画像を必要に応じて変更してください。

<br>

![image](https://github.com/user-attachments/assets/0688bd02-15f6-4bcc-a87e-d2d853b6d149)

<br>

## 4. 補足

### 4.1. イベントの実行条件について

本プラグインを導入すると、イベントの実行条件にターン数を指定することができなくなります。

そのため、ターン経過を判定する代替手段として、  
イベントの実行条件の「スクリプト」に以下を貼り付けることで  
「指定したユニットに AT が何回まわってきたか」で条件判定できるようにしています。

```
WaitTurnOrderManager.getATCount(ユニットのID, ユニットの所属) === ATがまわってきた回数
```

ユニットの所属は、以下の分類から該当する UnitGroup.～を選んでください。

| 所属           | UnitGroup            |
| -------------- | -------------------- |
| プレイヤー     | UnitGroup.PLAYER     |
| 敵             | UnitGroup.ENEMY      |
| 敵イベント     | UnitGroup.ENEMYEVENT |
| 同盟           | UnitGroup.ALLY       |
| 同盟イベント   | UnitGroup.ALLYEVENT  |
| 援軍           | UnitGroup.REINFORCE  |
| ゲスト         | UnitGroup.GUEST      |
| ゲストイベント | UnitGroup.GUESTEVENT |
| ブックマーク   | UnitGroup.BOOKMARK   |

例えば、敵の ID:5 のユニットに 2 回目の AT がまわってきたときに実行したい場合、  
以下のように入力します。

```
WaitTurnOrderManager.getATCount(5, UnitGroup.ENEMY) === 2
```

"==="の部分は、判定したい条件に応じて以下のように変更することもできます。

| 記号 | 条件     |
| ---- | -------- |
| <    | 未満     |
| <=   | 以下     |
| >=   | 以上     |
| >    | より多い |

例えば、プレイヤーの ID:3 のユニットに AT がまわってきた回数が 5 回以上のときに実行したい場合、  
以下のように入力します。

```
WaitTurnOrderManager.getATCount(3, UnitGroup.PLAYER) >= 5
```

<br>

また、`WaitTurnOrderManager.getMapTotalWT()`を使用することで経過 WT 値を取得することができます。  
例えば、経過 WT 値が 1000 以上のときにイベントを実行したい場合、以下のように入力します。

```
WaitTurnOrderManager.getMapTotalWT() >= 1000
```

`WaitTurnOrderManager.getMapTotalWT()`は戻り値として経過 WT 値を返すので、  
スクリプトの実行で変数に入れることもできます。  
これを利用して「ゲーム開始からゲームクリアまでの経過 WT 値の合計をカウントする」などの応用も可能です。

<br>
